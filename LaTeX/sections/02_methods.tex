% Indicate the main file. Must go at the beginning of the file.
% !TEX root = ../main.tex

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 02_methods
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Methods}
\label{methods}

\subsection{Data}%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The used data for this project is the SwissImage RS \autocite{swisstopoSWISSIMAGERS2024}
data from the Swiss Federal Office of Topography (SwissTopo).
It is a raster dataset with a resolution of 0.1m containing four bands: RGB and NIR.
In order to cover the area of interest (AOI) 6 tiles of the dataset are needed.
Over this large AOI there are three areas labeled with the corresponding labels \autoref{fig:aoi_labeled}.
These labels were provided by a team of researchers from the ZHAW. The three
areas are distributed over a residential area (83487m\textsuperscript{2}),
an industrial area (132642m\textsuperscript{2}) and a rural area (82740m\textsuperscript{2}).
Two kinds of labels are available: The landcover category \autoref{fig:category_areas} and an assessment of the 
degree of perviousness \autoref{fig:sealed_areas}. In \autoref{fig:label_distribution} the distribution of
the data available for each label is shown for both the landcover category and the sealing assessment.
A third kind of labels was generated by simplifying the degree of perviousness into two classes: pervious and impervious.
This was done by reclassifying the unknown areas to sealed ones since they only consist of BuildingDistortions and
ConstructionSites.

\begin{figure}[H]
    \centering
    \captionsetup{width=0.8\linewidth}
    \includegraphics[scale=0.6]{figures/map_aoi.pdf}
    \caption{Map of the AOI in Pratteln, a  municipality in the canton of Basel-Landschaft, Switzerland. 
    The three marked areas, each split in four tiles, are the tree areas with corresponding labels. 1 - 4 are in the rural area,
    5 - 8 in the residential area and 9 - 12 in the industrial area.}
    \label{fig:aoi_labeled}
\end{figure}

\begin{figure}[H]
    \centering
    \captionsetup{width=0.8\linewidth}
    \includegraphics[width=\linewidth]{figures/map_aoi_category.pdf}
    \caption{The three areas with the corresponding landcover categories.}
    \label{fig:category_areas}
\end{figure}

\begin{figure}[H]
    \centering
    \captionsetup{width=0.8\linewidth}
    \includegraphics[width=\linewidth]{figures/map_aoi_sealing.pdf}
    \caption{The three areas with the corresponding degree of perviousness.}
    \label{fig:sealed_areas}
\end{figure}

\begin{figure}[H]
    \centering
    \captionsetup{width=0.8\linewidth}
    \includegraphics[scale=0.6]{figures/area_by_category_and_seal.pdf}
    \caption{Available data by label, colored by the area.}
    \label{fig:label_distribution}
\end{figure}


\subsection{Programming Language and Frameworks}%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

To build and train the deep learning model, the programming language Python was used.
The Frameworks PyTorch and Lightning are widely used and powerful tools for building
deep learning models.


\subsection{Model}%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\subsection{Data Processing and Augmentation}%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{Preprocessing}%---------------------------------------
In a first step the data was processed using ArcGIS Pro. The process included a few steps implemented as
a model with the Model Builder \autoref{fig:processing_model}. The 6 tiles where mosaicked together and the area of interest 
was clipped. The area labels 1 - 12 and both versions of available data labels where transformed to raster datasets
and added as additional bands to the dataset. The data was then exported as a GeoTIFF file.
In order to use the data in a neural network an additional step was necessary. Using Python,
the data was transformed into Zarr format. This format is a chunked, compressed, N-dimensional array
storage format with multi-scale support. This allows for lazy loading and therefore for a more memory
efficient data access during training.

\begin{figure}[H]
    \centering
    \captionsetup{width=0.8\linewidth}
    \includegraphics[width=\linewidth]{figures/ArcGIS_Model.png}
    \caption{ArcGIS model used for preprocessing the data.}
    \label{fig:processing_model}
\end{figure}


\subsubsection{Processing and Augmentation}%-------------------------------

To feed the data into a neural network a PyTorch DataLoader was implemented.
The DataLoader indexes the available data depending on the cutout size and the 
corresponding area labels depending on the purpose - refer to \autoref{tab:areas}. 
It handles the data augmentation on the fly, during training steps.
For the data augmentation a parent class BaseAugmentor was implemented from which the different augmenters inherit. 
The implemented augmentors - refer to \autoref{tab:augmentors} - are then chained into a object of the class AugmentorChain
which can be used in the DataLoader.

\begin{table}[h!]
    \centering
        \begin{tabular}{|l|l|}
        \hline
        \textbf{Category}          & \textbf{Areas}       \\ 
        \hline
        Areas for Training         & 1, 2, 5, 6, 9, 10   \\
        Areas for Validation       & 3, 7, 11            \\
        Areas for Testing          & 4, 8, 12            \\ 
        \hline
        \end{tabular}
    \caption{Division of Areas for Training, Validation, and Testing}
    \label{tab:areas}
\end{table}

\begin{table}[H]
    \centering
        \begin{tabular}{|l|l|}
        \hline
        \textbf{Augmentor} & \textbf{Description} \\
        \hline
        FlipAugmentor & Randomly flips the image vertically and horizontally\\
        RotateAugmentor & Randomly rotates the image 0, 90, 180 or 270Â° \\
        PixelNoiseAugmentor & Adds random noise to the image (parameter: scale) \\
        ChannelNoiseAugmentor & Adds random noise to the channels (parameter: scale) \\
        \hline
        \end{tabular}
    \caption{Implemented augmentors}
    \label{tab:augmentors}
\end{table}



\subsection{Fitting The Model}%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\subsection{Evaluation}%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
